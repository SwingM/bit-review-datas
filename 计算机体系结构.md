# 计算机体系结构

## CHAP1

多层级结构：

​		计算机系统 = 软件 + 硬件（固件）

​		结构： |——功能划分多层级

​				 	|——物理层级

虚拟机：由软件实现的计算机机器

层级划分：

1. 0-1级，计算机组成与系统结构
2. 2-4级，系统软件
3. 5级，应用软件

**术语解释：**

- 翻译，高级机器级程序 → 转换程序 → 低级机器级程序，然后实现；
- 解释，低级机器上用一串 语句/指令 来实现高级机器上一条 语句/指令 功能。

↑ 翻译时间短，解释空间小

↑ 逻辑上，硬件软件实现功能等效。

###### 结构：层次结构中的传统机器级结构。

↑定义：

- 程序员所看到的计算机系统属性（概念性结构和功能特性）
- 计算机系统各级界面的划分、定义和上下功能分配

计算机设计量化准则：Amdahl定律系统某一部件采用某种更快执行的方式后**整个系统性能的提高**与这种执行方式的**使用频率**或**占总执行时间的比例**有关——加速比。
$$
Fe = （可改进部分占用时间）/（改进前整个任务执行时间）
$$

$$
Se = （改进前改进部分的执行时间）/（改进后改进部分的执行时间）
$$

| Action                 | time                                           |
| ---------------------- | ---------------------------------------------- |
| 改进后整个任务执行时间 | *Tn = T0 · [1 - Fe + (Fe / Se) ]*              |
| 改进后系统加速比       | *****Sn = T0 / Tn = 1 / [1 - Fe + (Fe / Se) ]* |

**CPU性能公式：**

| Name    | formula                  |
| ------- | ------------------------ |
| CPU时间 | CPU时钟周期数 / 时钟频率 |
| CPU时间 | IC · CPI / 时钟频率      |
| CPI     | Σ ( CPIi · Ii / IC )     |

系统结构评价标准：

1. 主频：同类处理机之间比较

2. 指令执行速度：MIPS = 指令条数 / （执行时间 · 10^6）= Fz / CPI = IPC · Fz

3. 等效指令速度（基普森法）：

   | 等效指令执行时间T | Σ ( Wi · Ti )         |
   | ----------------- | --------------------- |
   | 等效指令速度MIPS  | 1 /  Σ ( Wi / MIPSi ) |
   | 等效CPI           | Σ ( CPIi · Wi )       |

并行性：

1. 同时性，多个事件同一时刻发生
2. 并发性，多个事件同一时间间隔内发生

**计算机分类**：

1. ***佛林法***：按**指令流**和**数据流**的**多倍性**特征分类
   1. **指令流**：机器执行的指令序列
   2. **数据流**：指令流调用的数据序列（输入、中间）
   3. **多倍性**：**系统性能瓶颈部件**上同事处于**同一执行阶段**的**指令/数据**的最大可能个数
      1. SISD
      2. SIMD
      3. MISD
      4. MIMD

## CHAP2

数据表示：

1. 数据表示：计算机硬件直接识别，可以被指令系统直接调用的数据类型
2. 数据结构

**自定义数据表示：**

1. 带标志服的数据表示法：标志符 + 数值 （用于一个数据）
2. 数据描述符表示法：描述符和数据分开放（用于一组数据）
   1.  描述符 ： 101 + 标志位 + 长度 + 地址
   2. 数据： 000 + 数值

寻址：寻找操作数及数据存放单元

方式：

1. 直接定位：装入主存前，程序中指令/数据的主存物理地址已经确定
2. 静态定位：装入主存过程中进行地址变换，确定指令/数据主存物理地址
3. 动态定位：程序执行时，访问到相应指令/数据时进行地址变换

操作码优化：

- 固定长度
- **哈夫曼编码**
- 扩展编码

###### ***<u>哈夫曼编码：</u>***

最短平均长度（信息源熵）：
$$
H = -Σ [pi * log2(pi)]
$$
信息冗余（Redundant）：
$$
R = 1 - H / 实际平均码长
$$
↑平均码长固定



指令系统优化设计：

1. 复杂指令系统计算机CISC：增强指令功能（1条指令代替1串）
2. 精简指令系统计算机RISC：保留简单指令，复杂任务用子程序实现



**RISC:**

1. 延时转移技术：在转移指令后插入一条不相关的有效指令，转移指令被延迟执行
2. 指令取消技术：
   1. 向后转移（循环）
   2. 向前转移（if-then）
   3. 隐含转移技术
3. 重叠寄存器窗口技术：设置数量大的寄存器堆，分窗口；每个过程用的几个窗口中有一个与前一个过程共用，有一个和下一个过程共用
4. 指令流调整技术：变量重命名消除数据相关——提高流水线执行效率
5. 硬件为主固件为辅



## CHAP3

IO系统：

1. 特性
   1. 异步性
   2. 实时性
   3. 与设备无关性
2. 方式
   1. 程序控制IO
   2. 直接存储访问（DMA）
   3. IO处理机

磁盘阵列（RAID）：

| Level | Name                     | DataDisks | Redundant | CheckDisks |
| ----- | ------------------------ | --------- | --------- | ---------- |
| 0     | 无冗余无校验             | 8         | 0         | 0          |
| 1     | 镜像                     | 8         | 1         | 8          |
| 2     | 纠错海明码               | 8         | 1         | 4          |
| 3     | 位交叉奇偶校验           | 8         | 1         | 1          |
| 4     | 块交叉奇偶校验           | 8         | 1         | 1          |
| 5     | 无独立校验盘奇偶校验     | 8         | 1         | 1          |
| 6     | 双维无独立校验盘奇偶校验 | 8         | 2         | 2          |

总线：

1. 类型
   1. 单工
   2. 双工
      1. 半双工
      2. 全双工
2. 控制方式
   1. 集中式
   2. 分布式
3. 优先次序裁决
   1. 链式
   2. 计数器定时
   3. 独立其你去
4. 通信技术                                                                 
   1. 异步
   2. 同步

<!--↑名词解释-->

- 数据宽度：IO设备取得总线后传输数据总量
- 数据通路宽度：数据传送的物理宽度（一个时钟周期内传送信息量），取决于数据总线线数

**通道处理机：**

1. 字节多路通道：多台 低/中速 外围设备（含多个子通道，每个接一个设备控制器）
2. 选择通道：高速 外围设备（仅有一个成组工作的子通道）
3. 数组多路通道：每次一台 高速 外围设备（一个数据块），并轮流给多设备使用

读出过程：定位—找扇区—读数据

通道流量分析：

- 通道流量（吞吐量）：单位时间内传送最大数据量

- 通道最大流量：满负荷运作流量

  - $$
    fMAX.BYTE = (p*n)/[(Ts+TD)*p*n] = 1 / (Ts+TD) Bytes/s
    $$

  - $$
    fMAX.SELECTE = (p*n)/{[(Ts/n)+TD]*p*n} = 1/[(Ts/n)+TD] Bytes/s
    $$

  - $$
    fMAX.BLOCK = (p*n)/{[(Ts/k)+TD]*p*n} = 1/[(Ts/k)+TD] Bytes/s
    $$

- 整体关系：

  - fBYTE = Σ fi
  - fSELECTE = Max fi
  - fBLOCK = Max fi

- ↑均应小于最大流量

## CHAP4

存储器主要性能：速度、容量、价格

- 速度：访问周期、读出时间、频带宽度
- 容量：B/KB/MB/GB/TB/PB
- 价格：￥/bit



存取址方案：

1. 并行访问存储：m字w位 → m/n字 n*w位存储器 （地址码分两个部分，前部分选址，后部分选位）
2. 高位交叉访问存储：扩大了存储容量，用地址码高位区分存储体号码
3. 低位交叉访问存储：扩大了访问速度，用地址码低位区分存储体号码



主存—副存层次：扩大容量。

Cache——主存层次：提高存储速度。



程序局部性：时间/空间上局部性

- 时间局部性：最近被访问的代码不久还将被访问（循环）
- 空间局部性：地址上相邻代码容易被一起存取（顺序、向量、阵列）



存储系统平均价格：
$$
C = (C1*S1 + C2*S2) / (S1 + S2)
$$
存储系统公式一类：

- 表示方法：

  - 访问周期
  - 存取周期
  - 存储周期
  - 存取时间
  - 读出时间

- **命中率H：**在M1存储器中访问到的概率（N1：M1访问次数；N2：M2访问次数）
  $$
  H = N1 / (N1 + N2)
  $$

  - 访问周期和命中率：

    - 同时：
      $$
      T = HT1 + (1-H)T2
      $$

    - 不同时：
      $$
      T = T1 + (1-H)T2
      $$

- **访问效率：**
  $$
  e = T1/T2 = T1/[HT1 + (1-H)T2] = 1/[H + (1-H)T2/T1] = f(G,T2/T1)
  $$
  ![image-20210613003204680](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613003204680.png)



提高命中率：

- 预取技术：未命中，把M2存储器相邻单元组成的块送入M1
  - 公式：![image-20210613003315152](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613003315152.png)（n为数据块大小和复用次数相乘)
- 提高H / s1s2相差别太大 / 加快内部地址映像、变换



虚拟存储系统：

- 主存地址： ![image-20210613003922453](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613003922453.png)
- 虚存地址：![image-20210613003935241](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613003935241.png)



**页面替换算法**：

1. 随机算法（RAND）：随机换出去一个
2. 先进先出（FIFO）：利用历史信息，不反应局限性，先进的先出
3. 近期最少（LFU）：难
4. 最久没用（LRU）
5. 最有替换（OPT）：不可能



寻址索引：

1. 目录表
2. 快慢表
3. 散列函数



Cache

- 地址映像：把主存程序放进Cache并建立主存地址和Cache地址的函数
- 地址变换：运行时主存地址 f→ Cache地址

映像方式：

1. 全相联映像：

   1. 主存如何一块都可以映像到Cache任何一块

   2. | cache | 主存 | 映像关系 |
      | ----- | ---- | -------- |
      | Cb    | Mb   | Cb*Mb    |

2. 直接映像：

   1. 主存一块只能映像到Cache特定一块

   2. | Cache块号    | 主存的块号 | cache的块数 |
      | ------------ | ---------- | ----------- |
      | b = B mod Cb | B          | Cb          |

3. 组相联映像：

   1. 位选择：主存和Cache按同样大小分块，Cache分组，主存分分组。组内全相联，块间直接映像。



Cache更新算法：

1. 写直达法：CPU写操作，同时写入Cache和主存
2. 写回法：CPU值写入Cache，替换时，Cache写主存
   1. 不按写分配法：写Cache不命中，只把要写的字写入主存（用于直达法
   2. 按写分配法：写Cache不命中，把一个块读入Cache（用于写回法

Cache预取算法：

1. 按需取：Cache不命中，把一个块取入Cache
2. 恒预取：无论是否命中，取入下一个块
3. 不命中预取：不命中，取当前块和下一块

# CHAP5

重叠方式：

1. 顺序执行方式：n条用时 T = Σ(t取 + t分 + t执) / 每段均为t时，**3nt**
2. 一次重叠（简单流水线）：n条用时 T =**(1+2n)t**
3. 二次重叠：n条用时 T = **(2 + n)t**



先行控制方式原理：缓冲技术和预处理技术

- 缓冲技术：工作速度不固定的两个部件中间设置缓冲栈，平滑工作
- 预处理技术

流水方式：

- 特点：
  - 只有连续同类任务才能加效率
  - 每一个流水线段都要加入流水锁存器
  - 各流水段时间应尽量相等
  - 流水线有“装入时间”和“排空时间”
- 分类：
  - 线性流水线：每个流水段都流过且仅流过一次
  - 非线性流水线：某些段落反馈回路、前馈回路
  - 指令流水线
  - 部件流水线
  - 单功能
  - 多功能
- 静动态：
  - 静态流水线：同时间内，多功能流水线各个功能段只能固定连接，实现**一种功能**
  - 动态流水线：同时间段内，可以改不同方式连接，**多功能**

流水线性能分析：

1. 吞吐率：**TP = n/Tk** （n为数量，Tk为时间），如果有连续输入n个，总时间为 **Tk = (k+n-1)δt**
   1. 提高吞吐率，可以![image-20210613121305622](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613121305622.png)
2. 加速比：**S = 顺序执行T0 / 流水线时间Tk**
3. 效率： **E = T0 / k*Tk**
4. ↑关系 **E = TP*δt**，**S = kE**



向量流水处理/机：

1. 横向处理方式：向量计算按行，从左向右
2. 纵向处理方式：向量计算按行，从上向下
3. 纵横处理方式：相结合

## 

## CHAP6

并行处理机：多个PU按方式互联，在一个CU控制下，对各自数据完成同一条指令。SIMD

6.1原理：

- 阵列处理机基本构形
- 分布式存储器的阵列处理机
- 集中式共享存储器的阵列处理器



6.3 互联网络：

- 表示方法
  - 互联函数表示法
  - 图形表示法
  - IO对应表示法
- 特性：有向边/无向边连接有限结点
  - 网络规模：结点个数
  - 结点度：出入度
  - 距离：两个结点间最少的边数
  - 直径：网络中任意两个结点间距最大值
  - 线长：两个结点间连线长度
  - 对称性
- 性能参数：
  - 频带宽度：传输信息最大速率
  - 传输时间：消息长度÷频宽
  - 飞行时间：第一位信息到达的时间
  - 传输时延：飞行时间+传输时间
  - 发送方开销：处理器放消息上网的时间
  - 接收方开销：处理器取出信息的时间
  - **总时延： 发送方开销 + 飞行时间 + 传输时延 +接收方开销**

基本单级互联网：

1. 立方体单级网络：n维度，N节点共有 n = log2N种互联函数。![image-20210613150048867](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613150048867.png)
2. PM2I单级网络：加减2网络，可以实现与**j号**处理单元直接相连**j±2**号处理单元![image-20210613150139184](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613150139184.png)
3. 混洗交换单级网络：函数为 shuffle(Pn-1......p0)=pn-2......p1p0pn-1![image-20210613150234361](C:\Users\18600\AppData\Roaming\Typora\typora-user-images\image-20210613150234361.png)

## CHAP7

多级处理机：2+处理机（含PU、CU）高速互联网连接，在同一个OS实现指令以上级别（任务、作业级）并行。MIMD



分类法：

- 连接程度：
  - 紧密耦合多处理机
  - 松散耦合多处理机
- 共享主存：
  - 共享存储器多处理机
  - 分布式存储器多处理机
- 处理机：
  - 同构型多处理机
  - 异构型多处理机



多处理机系统特点：

